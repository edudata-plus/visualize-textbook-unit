<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>教科書関係可視化</title>
  <script src="https://unpkg.com/cytoscape@3.22.0/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/webcola/WebCola/cola.min.js"></script>
  <script src="https://unpkg.com/cytoscape-cola/cytoscape-cola.js"></script>
  <style>
    #cy {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
    }
    #lod-input {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }
    #lod-input label {
      margin-right: 10px;
    }
    #lod-uri {
      flex-grow: 1;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <div id="lod-input">
    <label for="lod-uri">教科書LOD URI:</label>
    <input type="text" id="lod-uri" placeholder="LODのURIを入力" value="https://w3id.org/jp-textbook/小学校/2019/国語/301">
    <button onclick="fetchSPARQLData()">読み込み</button>
  </div>
  <script>
    async function fetchSPARQLData() {
      const uri = document.getElementById('lod-uri').value;
      if (!uri) {
        alert("LODのURIを入力してください。");
        return;
      }
      
      const endpoint = "https://dydra.com/masao/jp-textbook/sparql"; // SPARQLエンドポイントを指定
      const query = `PREFIX t: <https://w3id.org/jp-textbook/>
                     PREFIX schema: <http://schema.org/>
                     SELECT ?unit ?name ?item ?title WHERE {
                       ?unit a t:TeachingUnit.
                       ?unit schema:workExample ?w.
                       ?w schema:isPartOf <${uri}>.
                       <${uri}> schema:name ?title.
                       ?unit schema:name ?name.
                       ?unit <https://w3id.org/jp-cos/cosItem> ?item.
                     }`;
      
      const url = endpoint + "?query=" + encodeURIComponent(query) + "&format=json";
      try {
        const response = await fetch(url, { headers: { "Accept": "application/sparql-results+json" } });
        const data = await response.json();
        
        const elements = [];
        let textbookId = `textbook-${uri}`;
        let textbookTitle = "";
        
        data.results.bindings.forEach(row => {
          if (!textbookTitle) {
            textbookTitle = row.title.value;
            elements.push({ data: { id: textbookId, label: textbookTitle }, classes: 'textbook' });
          }
          
          elements.push({ data: { id: row.unit.value, label: row.name.value, parent: textbookId }, classes: 'unit' });
          elements.push({ data: { id: row.item.value, label: row.item.value }, classes: 'detail' });
          elements.push({ data: { source: row.unit.value, target: row.item.value } });
        });

        const cy = cytoscape({
          container: document.getElementById('cy'),
          elements: elements,
          style: [
            {
              selector: 'node',
              style: {
                'min-zoomed-font-size': '10px'
              }
            },
            {
              selector: 'node.textbook',
              style: {
                'background-color': '#E3F2FD',
                'border-color': '#1E90FF',
                'border-width': 2,
                'shape': 'roundrectangle',
                'padding': 10,
                'label': 'data(label)',
                'text-valign': 'top',
                'text-halign': 'center',
                'color': '#1E90FF',
                'min-zoomed-font-size': '10px',
                'font-size': '16px'
              }
            },
            {
              selector: 'node.unit',
              style: {
                'background-color': '#32CD32',
                'shape': 'ellipse',
                'width': 'label',
                'height': 'label',
                'label': 'data(label)',
                'text-valign': 'center',
                'color': '#fff',
                'min-zoomed-font-size': '10px',
                'font-size': '14px'
              }
            },
            {
              selector: 'node.detail',
              style: {
                'background-color': '#FF4500',
                'shape': 'diamond',
                'width': 'label',
                'height': 'label',
                'label': 'data(label)',
                'text-valign': 'center',
                'color': '#fff',
                'min-zoomed-font-size': '10px',
                'font-size': '14px'
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#aaa',
                'target-arrow-color': '#aaa',
                'target-arrow-shape': 'triangle'
              }
            }
          ],
          layout: {
            name: 'cola',
            nodeSpacing: 20,
            edgeLengthVal: 20,
            alignment: undefined,
            avoidOverlap: true,
            fit: true,
            animate: true,
            maxSimulationTime: 4000
          },
          zoomingEnabled: true,
          panningEnabled: true
        });
      } catch (error) {
        console.error("データの取得に失敗しました:", error);
        alert("データの取得に失敗しました。");
      }
    }
  </script>
</body>
</html>
