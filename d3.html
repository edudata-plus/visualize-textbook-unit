<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>教科書関係可視化</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    #graph {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
    }
    #lod-input {
      margin-top: 10px;
      display: flex;
      align-items: center;
    }
    #lod-input label {
      margin-right: 10px;
    }
    #lod-uri {
      flex-grow: 1;
      padding: 5px;
    }
    .browse-list {
      float: left;
      margin-right: 15px;
    }
    .browse-list h1 {
      font-size: medium;
    }
  </style>
</head>
<body>
  <svg id="graph"></svg>
  <div id="lod-input">
    <label for="lod-uri">教科書LOD URI:</label>
    <input type="text" id="lod-uri" placeholder="LODのURIを入力">
    <button onclick="fetchSPARQLData()">読み込み</button>
  </div>
  <div class="browse-list">
    <ul>
      <li><a href="javascript:fetchSubjectData('https://w3id.org/jp-textbook/curriculum/小学校/2020')">小学校</a></li>
      <li><a href="javascript:fetchSubjectData('https://w3id.org/jp-textbook/curriculum/中学校/2021')">中学校</a></li>
      <li><a href="javascript:fetchSubjectData('https://w3id.org/jp-textbook/curriculum/高等学校/2022')">高等学校</a></li>
    </ul>
  </div>
  <nav class="browse-list" style="visibility: hidden">
    <h1>種目</h1>
    <ul id="subject-list">
    </ul>
  </nav>
  <nav class="browse-list" style="visibility: hidden;">
    <h1>教科書</h1>
    <ul id="subject-list">
    </ul>
  </nav>
  <script>
    async function fetchSubjectData(uri) {
      if (!uri) {
        alert("Subject URI not found");
        return;
      }
      const endpoint = "https://dydra.com/masao/jp-textbook/sparql";
      const query = `PREFIX t: <https://w3id.org/jp-textbook/>
                     PREFIX schema: <http://schema.org/>
                     select * where {
                     <${uri}> t:hasSubjectArea ?area.
                     ?area t:hasSubject ?subject.
                     ?subject schema:name ?subject_label.
                     ?subject <http://purl.org/linked-data/cube#order> ?order.
                     FILTER (lang(?subject_label) = 'ja')
                     } order by ?order`;
      const url = endpoint + "?query=" + encodeURIComponent(query) + "&format=json";
      try {
        const response = await fetch(url, { headers: { "Accept": "application/sparql-results+json" } });
        const data = await response.json();
        //let subjects = [];
        let subject = document.getElementById("subject-list");
        console.log(subject.parentElement.style.visibility);
        subject.parentElement.style.visibility = "visible";
        console.log(subject.parentElement.style.visibility);
        subject.innerHTML = "";
        for (const row of data.results.bindings) {
          subject.innerHTML += `<li><a href="${row.subject.value}">${row.subject_label.value}</li>`;
        }
      } catch (error) {
        console.error("種目データの取得に失敗しました:", error);
        alert("種目データの取得に失敗しました。");
      }
    };
  </script>
  <script>
    async function fetchSPARQLData() {
      const uri = document.getElementById('lod-uri').value;
      if (!uri) {
        alert("LODのURIを入力してください。");
        return;
      }
      const endpoint = "https://dydra.com/masao/jp-textbook/sparql";
      const query = `PREFIX t: <https://w3id.org/jp-textbook/>
                     PREFIX schema: <http://schema.org/>
                     SELECT ?unit ?name ?item ?title WHERE {
                       ?unit a t:TeachingUnit.
                       ?unit schema:workExample ?w.
                       ?w schema:isPartOf <${uri}>.
                       <${uri}> schema:name ?title.
                       ?unit schema:name ?name.
                       ?unit <https://w3id.org/jp-cos/cosItem> ?item.
                     }`;
      
      const url = endpoint + "?query=" + encodeURIComponent(query) + "&format=json";
      try {
        const response = await fetch(url, { headers: { "Accept": "application/sparql-results+json" } });
        const data = await response.json();
        
        let nodes = [], links = [];
        let textbookNode = { id: uri, label: data.results.bindings[0].title.value, group: "textbook" };
        nodes.push(textbookNode);
        
        for (const row of data.results.bindings) {
          if (!nodes.find(n => n.id === row.unit.value)) {
            nodes.push({ id: row.unit.value, label: row.name.value, group: "unit" });
          }
          links.push({ source: textbookNode.id, target: row.unit.value });
          
          if (!nodes.find(n => n.id === row.item.value)) {
            let itemLabel = row.item.value.slice(-16); // URIの末尾16桁をラベルとして使用
            nodes.push({ id: row.item.value, label: itemLabel, group: "detail" });
          }
          links.push({ source: row.unit.value, target: row.item.value });
        }
        renderGraph(nodes, links);
      } catch (error) {
        console.error("データの取得に失敗しました:", error);
        alert("データの取得に失敗しました。");
      }
    }

    function renderGraph(nodes, links) {
      const width = 800, height = 600;
      const svg = d3.select("#graph").attr("width", width).attr("height", height);
      svg.selectAll("*").remove();

      // ツールチップ用のdivを作成
      const tooltip = d3.select("body").append("div")
        .style("position", "absolute")
        .style("visibility", "hidden")
        .style("background", "lightgray")
        .style("padding", "5px")
        .style("border-radius", "5px")
        .style("font-size", "12px");

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("x", d3.forceX(width / 2).strength(0.1))
        .force("y", d3.forceY(height / 2).strength(0.1));
      
      const link = svg.selectAll(".link")
        .data(links)
        .enter().append("line")
        .attr("stroke", "#999")
        .attr("stroke-width", 2);
      
      const node = svg.selectAll(".node")
        .data(nodes)
        .enter().append("circle")
        .attr("r", 10)
        .attr("fill", d => d.group === "textbook" ? "blue" : d.group === "unit" ? "green" : "red")
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));
      
      node.on("mouseover", function (event, d) {
        tooltip.style("visibility", "visible").text( d.label );
      })
      .on("mousemove", function (event) {
        tooltip.style("top", (event.pageY + 10) + "px")
          .style("left", (event.pageX + 10) + "px");
      })
      .on("mouseout", function () {
        tooltip.style("visibility", "hidden");
      });

      const label = svg.selectAll(".label")
        .data(nodes)
        .enter()
        .append("a")
        .attr("xlink:href", d => d.id)
        .attr("target", "_blank")
        .append("text")
        .attr("dy", -10)
        .attr("text-anchor", "middle")
        .attr("font-size", "10px")
        .text(d => d.label);
      
      simulation.on("tick", () => {
        link.attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        
        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);
      });
      
      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      
      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }
      
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    }
  </script>
</body>
</html>